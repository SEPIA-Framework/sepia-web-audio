<!doctype html>
<html lang="en-us">
<head>
	<meta charset="utf-8">
	<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>SEPIA Web Audio Input-Output Test</title>

	<script type="text/javascript" src="src/sepia-web-audio.js?v=0.9.7"></script>
	<script>
		//set correct modules folder
		SepiaFW.webAudio.defaultProcessorOptions.moduleFolder = "src/modules";
	</script>
	
	<link rel="stylesheet" type="text/css" href="tests.css?v=0.9.7">
	<style></style>
</head>
<body>
<div id="mainView">
	<h1>SEPIA Web Audio Processor - Input/Output Tests</h1>
	<div>
		<button onclick="tutorialPart1();">Tutorial Part 1</button>
		<button onclick="tutorialPart2();">Tutorial Part 2</button>
	</div>
</div>
<script type='text/javascript'>
	
	//Tutorial Part 1
	function tutorialPart1(){
		var myModules = [];

		function bufferCallback(data){
			//handle samples here using: data.samples
			console.log("bufferCallback", data);
		}
		myModules.push({
			name: 'buffer-switch',
			settings: {
				onmessage: bufferCallback,
				options: {
					processorOptions: {
						bufferSize: 512, 	//size of samples generated
						passThroughMode: 0,	//0: none, 1: original (float32 array)
					}
				}
			}
		});
		
		var processor = new SepiaFW.webAudio.Processor({
			onaudiostart: function(){ console.log("onaudiostart", arguments); },
			onaudioend: function(){ console.log("onaudioend", arguments); },
			onrelease: function(){ console.log("onrelease", arguments); },
			onerror: function(){ console.error("onerror", arguments); },
			modules: myModules
			
		}, function(info){
			//Processor ready
			console.log(info); //Use 'info' to get details about source, sample-rate etc.
			//start
			processor.start();
			//wait 3s
			setTimeout(function(){
				//stop
				processor.stop();
				//wait 3s
				setTimeout(function(){
					processor.release();
				}, 3000);
			}, 3000);
			
		}, function(err){
			//Initialization error
			console.error(err);
		});
	}
	
	//Tutorial Part 2
	function tutorialPart2(){
		SepiaFW.webAudio.tryNativeStreamResampling = false;		//global option

		var myModules = [];
		var targetSampleRate = 16000;	//this is the sample-rate we want
		var bufferSize = 512;			//size of samples generated

		function resamplerCallback(data){
			//data will include e.g.: data.samples and data.rms (volume)
			console.log("resamplerCallback", data);
		}
		var resampler = {
			name: 'speex-resample-switch',
			settings: {
				onmessage: resamplerCallback,
				sendToModules: [],	//[moduleIndex] - filled below with index of wave-encoder module
				options: {
					processorOptions: {
						targetSampleRate: targetSampleRate,
						bufferSize: bufferSize,
						resampleQuality: 5,			//1 (low quality) - 10 (best quality)
						calculateRmsVolume: true,	//the resampler can calculate RMS signal volume
						gain: 5.0,					//we can amplify the signal here
						passThroughMode: 0			//0: none - only switch in our pipe atm
					}
				}
			}
		};
		
		function waveEncoderCallback(data){
			//can be used to track capture state and get final WAV
			//check: data.gate, data.output.wav, data.output.buffer
			console.log("waveEncoderCallback", data);
			if (data.gate && data.gate.isOpen === false){
				//stop processor
				processor.stop();
				//get data
				waveEncoder.handle.sendToModule({request: {get: "wave"}});
				waveEncoder.handle.sendToModule({request: {get: "buffer"}});
				//release after 3s
				setTimeout(function(){
					processor.release();
				}, 3000);
			}
			if (data.output && data.output.wav){
				//just for fun, add WAV to page:
				var targetEle = document.body;
				var blobType = "audio/wav";
				SepiaFW.webAudio.addAudioElementToPage(targetEle, data.output.wav, blobType);
			}
		}
		var waveEncoder = {
			name: 'wave-encoder',
			type: 'worker',
			handle: {},		//will be updated on init. with ref. to node.
			settings: {
				onmessage: waveEncoderCallback,
				options: {
					setup: {
						inputSampleRate: targetSampleRate,	//input of this will be ...
						inputSampleSize: bufferSize,		//... output of resampler
						lookbackBufferMs: 0,			//(experimental) ignore for now
						recordBufferLimitMs: 8000,		//we can apply recording limit as milliseconds
						//recordBufferLimitKb: 600,		//... or as kilobytes (default ~5MB)
						isFloat32: false	//resampler gives int16 - use e.g. for buffer module 
					}
				}
			}
		};
		
		myModules.push(resampler);		//index 1
		myModules.push(waveEncoder);	//index 2

		//connect resampler output to wave-encoder input:
		resampler.settings.sendToModules.push(2);
		
		var processor = new SepiaFW.webAudio.Processor({
			onaudiostart: function(){ 
				console.log("onaudiostart", arguments);
				waveEncoder.handle.sendToModule({gate: "open"});
			},
			onaudioend: function(){ 
				console.log("onaudioend", arguments); 
			},
			onrelease: function(){ console.log("onrelease", arguments); },
			onerror: function(){ console.error("onerror", arguments); },
			modules: myModules
			
		}, function(info){
			//Processor ready
			console.log(info); //Use 'info' to get details about source, sample-rate etc.
			//start
			processor.start();
			//wait 4s
			setTimeout(function(){
				//stop recorder
				waveEncoder.handle.sendToModule({gate: "close"});
			}, 4000);
			
		}, function(err){
			//Initialization error
			console.error(err);
		});
	}
</script>
</body>
</html>
